---
interface Props {
  activePage?: string;
}

const { activePage = "" } = Astro.props;

const navLinks = [
  { href: "/", label: "Inicio", ariaLabel: "Página de inicio" },
  { href: "/services", label: "Servicios", ariaLabel: "Nuestros servicios de psicología" },
  { href: "/blog", label: "Blog", ariaLabel: "Artículos y recursos" },
  { href: "/contact", label: "Contacto", ariaLabel: "Formulario de contacto" },
];
---

<header
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-500 py-4 lg:py-5"
  id="header"
  role="banner"
>
  <div
    class="absolute inset-0 bg-ivory/95 backdrop-blur-md border-b border-border-light/50 shadow-sm transition-all duration-500"
    id="header-bg"
  >
  </div>

  <div class="relative container-elegant">
    <div class="flex items-center justify-between">
      <!-- Logo -->
      <a 
        href="/" 
        class="flex items-center gap-3 group focus-ring rounded-lg"
        aria-label="María Ángeles Mata - Psicóloga Clínica, volver al inicio"
      >
        <div
          class="w-10 h-10 lg:w-11 lg:h-11 rounded-full border border-border-medium flex items-center justify-center transition-all duration-500 group-hover:border-sage group-hover:bg-sage/5 group-hover:scale-105"
        >
          <span
            class="font-serif text-lg lg:text-xl text-text-primary italic"
          >M</span>
        </div>
        <div class="hidden sm:flex flex-col">
          <span
            class="font-serif text-base lg:text-lg text-text-primary tracking-tight leading-none"
          >María Ángeles Mata</span>
          <span
            class="text-[9px] font-sans font-medium tracking-[0.25em] uppercase text-sage mt-1"
          >Psicóloga Clínica</span>
        </div>
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden lg:flex items-center gap-10" role="navigation" aria-label="Navegación principal">
        {
          navLinks.map((link) => (
            <a
              class={`nav-link focus-ring rounded ${activePage === link.label ? "active" : ""}`}
              href={link.href}
              aria-label={link.ariaLabel}
              aria-current={activePage === link.label ? "page" : undefined}
            >
              {link.label}
            </a>
          ))
        }
      </nav>

      <!-- CTA Button -->
      <div class="hidden lg:block">
        <a 
          href="/contact" 
          class="btn btn-primary py-2.5 px-6 text-sm magnetic"
          aria-label="Reservar cita de psicología"
        >
          <span>Reservar cita</span>
        </a>
      </div>

      <!-- Mobile Menu Button -->
      <button
        class="lg:hidden relative z-50 p-2 text-text-primary flex flex-col justify-center items-center gap-[5px] w-10 h-10 focus-ring rounded-lg"
        aria-label="Abrir menú de navegación"
        aria-expanded="false"
        aria-controls="mobile-menu"
        id="menu-toggle"
      >
        <span
          class="w-6 h-[1.5px] bg-current transition-all duration-300 origin-center block"
          aria-hidden="true"
        ></span>
        <span
          class="w-6 h-[1.5px] bg-current transition-all duration-300 origin-center block"
          aria-hidden="true"
        ></span>
      </button>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div
    class="lg:hidden fixed inset-0 bg-ivory/98 backdrop-blur-2xl z-40 opacity-0 pointer-events-none transition-all duration-500 ease-[cubic-bezier(0.16,1,0.3,1)]"
    id="mobile-menu"
    role="dialog"
    aria-modal="true"
    aria-label="Menú de navegación móvil"
  >
    <div class="flex flex-col h-full pt-32 pb-12 container-elegant">
      <nav class="flex flex-col gap-8 items-center text-center mt-8" role="navigation" aria-label="Navegación móvil">
        {
          navLinks.map((link, index) => (
            <a
              class={`font-serif text-3xl transition-all duration-300 opacity-0 translate-y-4 mobile-link ${
                activePage === link.label
                  ? "text-sage"
                  : "text-text-primary hover:text-text-secondary"
              }`}
              href={link.href}
              style={`transition-delay: ${index * 50}ms`}
              aria-label={link.ariaLabel}
              aria-current={activePage === link.label ? "page" : undefined}
            >
              {link.label}
            </a>
          ))
        }
      </nav>

      <div class="mt-auto flex flex-col items-center gap-6">
        <a 
          href="/contact" 
          class="btn btn-primary w-full max-w-xs"
          aria-label="Reservar cita de psicología"
        >
          <span>Reservar cita</span>
        </a>
        <a
          href="tel:+34661471971"
          class="text-text-secondary hover:text-text-primary transition-colors text-sm tracking-wide"
          aria-label="Llamar al 661 471 971"
        >
          Llamar: 661 471 971
        </a>
      </div>
    </div>
  </div>
</header>

<!-- Spacer for fixed header -->
<div class="h-20 lg:h-24" aria-hidden="true"></div>

<script>
  const header = document.getElementById("header");
  const headerBg = document.getElementById("header-bg");
  const menuToggle = document.getElementById("menu-toggle");
  const mobileMenu = document.getElementById("mobile-menu");
  const lines = menuToggle?.querySelectorAll("span");
  const mobileLinks = mobileMenu?.querySelectorAll(".mobile-link");
  let menuOpen = false;

  // Scroll behavior for header
  let lastScroll = 0;
  window.addEventListener("scroll", () => {
    const currentScroll = window.scrollY;
    
    // Header styling based on scroll
    if (currentScroll > 20) {
      header?.classList.remove("py-4", "lg:py-5");
      header?.classList.add("py-3", "lg:py-4");
      headerBg?.classList.add("shadow-md");
    } else {
      header?.classList.remove("py-3", "lg:py-4");
      header?.classList.add("py-4", "lg:py-5");
      headerBg?.classList.remove("shadow-md");
    }
    
    lastScroll = currentScroll;
  }, { passive: true });

  function toggleMenu() {
    menuOpen = !menuOpen;
    
    if (menuOpen) {
      mobileMenu?.classList.remove("opacity-0", "pointer-events-none");
      document.body.style.overflow = "hidden";
      menuToggle?.setAttribute("aria-expanded", "true");
      
      // Animate hamburger to X
      if (lines && lines.length === 2) {
        lines[0].style.transform = "translateY(3px) rotate(45deg)";
        lines[1].style.transform = "translateY(-3.5px) rotate(-45deg)";
      }
      
      // Animate links in
      mobileLinks?.forEach((link) => {
        link.classList.remove("opacity-0", "translate-y-4");
      });
    } else {
      mobileMenu?.classList.add("opacity-0", "pointer-events-none");
      document.body.style.overflow = "";
      menuToggle?.setAttribute("aria-expanded", "false");
      
      // Animate hamburger back
      if (lines && lines.length === 2) {
        lines[0].style.transform = "none";
        lines[1].style.transform = "none";
      }
      
      // Reset links
      mobileLinks?.forEach((link) => {
        link.classList.add("opacity-0", "translate-y-4");
      });
    }
  }

  menuToggle?.addEventListener("click", toggleMenu);

  // Close menu on link click
  mobileMenu?.querySelectorAll("a").forEach((link) => {
    link.addEventListener("click", () => {
      if (menuOpen) toggleMenu();
    });
  });

  // Close menu on escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && menuOpen) {
      toggleMenu();
    }
  });
  
  // Magnetic button effect
  if (!window.matchMedia('(pointer: coarse)').matches) {
    document.querySelectorAll('.magnetic').forEach(btn => {
      btn.addEventListener('mousemove', (e: Event) => {
        const mouseEvent = e as MouseEvent;
        const rect = (btn as HTMLElement).getBoundingClientRect();
        const x = mouseEvent.clientX - rect.left - rect.width / 2;
        const y = mouseEvent.clientY - rect.top - rect.height / 2;
        
        (btn as HTMLElement).style.transform = `translate(${x * 0.2}px, ${y * 0.2}px)`;
      });
      
      btn.addEventListener('mouseleave', () => {
        (btn as HTMLElement).style.transform = '';
      });
    });
  }
</script>
